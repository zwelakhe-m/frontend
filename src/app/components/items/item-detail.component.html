<div class="min-h-screen bg-gradient-to-br from-purple-50 via-white to-emerald-50">
  <!-- Loading State -->
  @if (loading()) {
  <div class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <div
        class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"
      ></div>
      <p class="text-gray-600">Loading item details...</p>
    </div>
  </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
  <div class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
          ></path>
        </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">{{ error() }}</h3>
      <button (click)="goBack()" class="btn-primary px-6 py-3 rounded-xl">Go Back</button>
    </div>
  </div>
  }

  <!-- Item Details -->
  @if (item() && !loading() && !error()) {
  <div class="max-w-7xl mx-auto px-6 py-8">
    <!-- Back Button -->
    <button
      (click)="goBack()"
      class="inline-flex items-center text-purple-600 hover:text-purple-700 mb-6 transition-colors"
    >
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 19l-7-7 7-7"
        ></path>
      </svg>
      Back to Browse
    </button>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Image Gallery -->
      <div class="space-y-4">
        <!-- Main Image -->
        <div class="relative aspect-square rounded-2xl overflow-hidden bg-gray-100">
          <img
            [src]="getCurrentImageUrl()"
            [alt]="item()?.title || 'Item'"
            class="w-full h-full object-cover"
          />

          <!-- Navigation Arrows (only show if multiple images) -->
          @if (item()?.images && item()!.images.length > 1) {
          <button
            (click)="previousImage()"
            class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
          </button>

          <button
            (click)="nextImage()"
            class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
          }
        </div>

        <!-- Thumbnail Gallery -->
        @if (item()?.images && item()!.images.length > 1) {
        <div class="grid grid-cols-4 gap-2">
          @for (image of item()!.images; track $index) {
          <button
            (click)="selectImage($index)"
            [class]="$index === currentImageIndex() ? 'ring-2 ring-purple-500' : ''"
            class="aspect-square rounded-lg overflow-hidden bg-gray-100 hover:opacity-80 transition-opacity"
          >
            <img
              [src]="getThumbnailUrl(image)"
              [alt]="
                item()?.title
                  ? item()?.title + ' thumbnail ' + ($index + 1)
                  : 'Thumbnail ' + ($index + 1)
              "
              class="w-full h-full object-cover"
            />
          </button>
          }
        </div>
        }
      </div>

      <!-- Item Information -->
      <div class="space-y-6">
        <!-- Header -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">
              {{ item()?.category }}
            </span>
            @if (hasRating()) {
            <div class="flex items-center">
              <span class="text-yellow-400 text-lg mr-1">â˜…</span>
              <span class="text-gray-700 font-medium">{{ getRatingValue().toFixed(1) }}</span>
              <span class="text-gray-500 text-sm ml-1"
                >({{ item()?.totalReviews || 0 }} reviews)</span
              >
            </div>
            }
          </div>

          <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ item()?.title }}</h1>

          <div class="flex items-center text-gray-600 mb-4">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
            {{ item()?.location || 'Location not specified' }}
          </div>

          <div class="flex items-baseline">
            <span class="text-4xl font-bold text-purple-600">{{
              formatPrice(item()!.pricePerDay)
            }}</span>
            <span class="text-gray-600 ml-2">per day</span>
          </div>
        </div>

        <!-- Availability Status -->
        <div class="flex items-center">
          @if (item()?.isAvailable) {
          <div class="flex items-center text-green-600">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            Available for rent
          </div>
          } @else {
          <div class="flex items-center text-red-600">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            Currently unavailable
          </div>
          }
        </div>

        <!-- Action Buttons -->
        <div class="space-y-3">
          @if (!isOwner() && item()?.isAvailable) {
          <button
            (click)="openBookingModal()"
            class="w-full btn-primary py-4 text-lg font-semibold rounded-xl"
          >
            Request to Rent
          </button>
          } @if (isOwner()) {
          <div class="grid grid-cols-2 gap-3">
            <button (click)="editItem()" class="btn-outline py-3 rounded-xl">Edit Item</button>
            <button (click)="viewItemBookings()" class="btn-primary py-3 rounded-xl">
              View Bookings
            </button>
          </div>
          } @if (!isOwner()) {
          <app-contact-owner
            [itemId]="item()!.id"
            [itemName]="item()!.title"
            [itemImage]="getCurrentImageUrl()"
            [pricePerDay]="item()!.pricePerDay"
            [ownerName]="item()!.ownerName || ''"
            [ownerId]="item()!.ownerId"
          >
          </app-contact-owner>
          }
        </div>

        <!-- Item Details -->
        <div class="bg-white bg-opacity-80 rounded-2xl p-6 shadow-sm mb-4">
          <h3 class="text-lg font-semibold text-primary-700 mb-4">About this item</h3>
          <p class="text-gray-700 leading-relaxed">{{ item()?.description }}</p>
        </div>

        <!-- Owner Information -->
        <div class="bg-white bg-opacity-80 rounded-2xl p-6 shadow-sm">
          <h3 class="text-lg font-semibold text-primary-700 mb-4">Owner</h3>
          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-gradient-to-r from-primary-500 to-primary-300 rounded-full flex items-center justify-center mr-4 shadow"
            >
              <span class="text-white font-semibold text-lg">{{
                item()?.ownerName?.charAt(0) || 'U'
              }}</span>
            </div>
            <div>
              <p class="font-semibold text-primary-800">{{ item()?.ownerName || 'Unknown' }}</p>
              <p class="text-sm text-primary-500">
                Member since {{ formatDate(item()!.createdAt) }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Modal -->
  @if (showBookingModal()) {
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-900">Request to Rent</h3>
        <button (click)="closeBookingModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <form (ngSubmit)="submitBooking()" class="space-y-4">
        <!-- Date Selection -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2"
              >Start Date</label
            >
            <input
              id="startDate"
              type="date"
              [(ngModel)]="bookingStartDate"
              [min]="getMinDate()"
              name="startDate"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            />
          </div>
          <div>
            <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2"
              >End Date</label
            >
            <input
              id="endDate"
              type="date"
              [(ngModel)]="bookingEndDate"
              [min]="bookingStartDate() || getMinDate()"
              name="endDate"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            />
          </div>
        </div>

        <!-- Message -->
        <div>
          <label for="message" class="block text-sm font-medium text-gray-700 mb-2"
            >Message (Optional)</label
          >
          <textarea
            id="message"
            [(ngModel)]="bookingMessage"
            name="message"
            rows="3"
            placeholder="Tell the owner why you need this item..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          ></textarea>
        </div>

        <!-- Booking Summary -->
        @if (bookingStartDate() && bookingEndDate()) {
        <div class="glass-card rounded-xl p-4 bg-gray-50">
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600">Duration:</span>
              <span class="font-medium">{{ calculateDays() }} days</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Price per day:</span>
              <span class="font-medium">{{ formatPrice(item()!.pricePerDay) }}</span>
            </div>
            <hr class="my-2" />
            <div class="flex justify-between text-lg font-semibold">
              <span>Total:</span>
              <span class="text-purple-600">{{ formatPrice(calculateTotal()) }}</span>
            </div>
          </div>
        </div>
        }

        <!-- Submit Button -->
        <button
          type="submit"
          [disabled]="bookingLoading() || !bookingStartDate() || !bookingEndDate()"
          class="w-full btn-primary py-3 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed"
        >
          @if (bookingLoading()) {
          <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
            Sending Request...
          </div>
          } @else { Send Booking Request }
        </button>
      </form>
    </div>
  </div>
  } }
</div>
